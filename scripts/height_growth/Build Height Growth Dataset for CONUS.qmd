---
title: "Build Height Growth Dataset for CONUS"
author: "Greg Johnson, David Marshall, Aaron Weiskittel"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: build_conus_hg_dataset
#| echo: false
#| message: false
#| warning: false


library( dplyr )
library( ggplot2 )
library(tidyverse)
library(sf)
library(terra)

states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))

data_path <- "F:/Projects/FVS Remodel/data/"
rds_path <- "F:/Projects/FVS Remodel/fvs_remodeling/rds/"
gis_path <- "F:/Projects/FVS Remodel/gis/"
unzip_path <- "F:/Projects/FVS Remodel/gis/Normal_1991_2020_bioclim"

species <- readRDS( paste0(rds_path,"species.RDS") )

tree_data <- readRDS( paste0(rds_path,"tree_data.RDS") )

tree_hg_subset <- tree_data %>% 
    filter( !is.na(startDIA) & !is.na(endDIA)  &  
            !is.na(startBAPA) & !is.na(endBAPA) &
            !is.na(startBAL) &!is.na(endBAL) & 
            !is.na(startCCFL) &!is.na(endCCFL) &
            !is.na(startCCH) &!is.na(endCCH) &
            !is.na(startCR) & !is.na(endCR) &
            !is.na(startHT) & !is.na( endHT ) &
            !is.na(startGROWYR) & !is.na(endGROWYR) & endGROWYR - startGROWYR >= 5 &
            !is.na( SICOND ) & !is.na(endHTCD) ) %>%
            mutate( startCR = startCR/100, endCR = endCR/100, SISP = ifelse(!is.na(SISP), SISP, fia_species ),
                    SIBASE = ifelse( !is.na( SIBASE ), SIBASE, 50 )) %>%
    inner_join( state_fips, by="STATECD")

ecoregions <- st_read( paste0( gis_path,"ecoregions.gpkg" ) )

raster_files <- list.files(
  path = unzip_path, 
  pattern = "\\.(tif|asc)$", 
  full.names = TRUE, 
  ignore.case = TRUE
)

# 1. Load the rasters
climate_stack <- rast(raster_files)

# 2. Get the clean base names (e.g., "Normal_1991_2020_MAT")
raw_names <- gsub("\\.(tif|asc)$", "", basename(raster_files), ignore.case = TRUE)

# 3. Remove the specific prefix "Normal_1991_2020_"
# The ^ ensures it only replaces the string if it's at the beginning
clean_names <- gsub("^Normal_1991_2020_", "", raw_names)

# 4. Assign back to the stack
names(climate_stack) <- clean_names

x <- tree_hg_subset |> group_by( PLOT, STATECD, UNITCD, COUNTYCD, LON, LAT ) |> summarize( n=length(LAT) )
x <- st_as_sf( x, coords = c("LON", "LAT"), crs = 4326 )
x <- st_transform( x, crs(climate_stack) )
x <- cbind( x, extract( climate_stack, x ) )

x <- st_transform( x, st_crs(ecoregions) )
x <- st_join( x, ecoregions, join = st_within )
x_cor <- st_coordinates( x )
x <- st_drop_geometry( x )
x <- cbind( x, x_cor )
 
tree_hg_subset <- tree_hg_subset |> 
                    inner_join( x |> select( -n, -STATE_NAME, -Shape_Leng, -Shape_Area, -layer ), 
                                by=c("PLOT","STATECD","UNITCD","COUNTYCD") )


saveRDS( tree_hg_subset, file=paste0(rds_path,"tree_hg_subset.RDS") )

hg_species <- tree_hg_subset %>% group_by( SPCD ) %>% summarize( n=n() ) %>% arrange( desc(n) )
saveRDS( hg_species, file=paste0(rds_path,"hg_species.RDS") )


knitr::kable( hg_species, caption = "Height Growth Observations by Species in FIA Change Dataset")

```
