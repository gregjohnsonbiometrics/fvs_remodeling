---
title: "Height Growth Equations for CONUS: Douglas-fir"
author: "Greg Johnson, David Marshall, Aaron Weiskittel"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: prepare_data
#| message: false
#| warning: false
#| include: false

library( dplyr )
library( ggplot2 )
library(tidyverse)
library(sf)
library(terra)


reformat_nls <- function( nls_model_summary )
{
    mat_model <- nls_model_summary$coefficients
    
    dg_model <- as.data.frame(mat_model)
    colnames(dg_model) <- c("Coef.", "Std. error", "t-stat.", "p")
    
    return( dg_model )
}

states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))

data_path <- "F:/Projects/FVS Remodel/data/"
rds_path <- "F:/Projects/FVS Remodel/fvs_remodeling/rds/"
gis_path <- "F:/Projects/FVS Remodel/gis/"

species <- readRDS( file=paste0(rds_path,"species.RDS") )
trees <- readRDS( file=paste0(rds_path,"tree_hg_subset.RDS") )

# observation threshold
min_obs <- 5000

fia_species <- 202
species_name <- species$CommonName[species$SPCD == fia_species]

tree_subset <- trees |> filter( SPCD == fia_species & !(State %in% c("NY","PA","MI","IL")))

max_height <- max( tree_subset$endACTUALHT, na.rm=T )

```

## Data

We took the FIA height growth data subset for `r species_name`, filtered out stray (likely keypunch errors) states (NY, PA, IL, and MI), FIA plot locations with missing EPA L3 Codes, and where the diameter at the end of the 5-year or greater measurement interval was less than the starting diameter. This left `r nrow(tree_subset)` growth observations.

The observations are distributed among L3 Codes as follows:

```{r}
#| label: l3_observations
#| echo: false
#| message: false
#| warning: false

knitr::kable( tree_subset |> group_by( NA_L3NAME, NA_L3CODE ) |> summarize( n = length(X) ) |> arrange(desc(n)) )

```



```{r}
#| label: height_growth_equation
#| echo: false
#| message: false
#| warning: false


est_hg <- function( periods, ht, cr, cr2, ccfl, ccfl2, max_height,
                          b1, b2, b3, b4 )
{
    htc <- ht
    crc <- cr
    ccflc <- ccfl
    crg <- (cr2 - cr)/periods
    ccflg <- (ccfl2 - ccfl)/ periods

    for( i in 1:max(periods) )
    {
        # abc * exp(-bx) * (1 - exp(-bX))^(c-1)
        htc <- htc + ifelse( i <= periods, 
                max_height * b1 * b2 * (crc)^b3 * exp(-b1*htc-b4*ccflc ) * (1.0-exp(-b1*htc))^(b2-1.0), 0.0 )

        crc <- crc + ifelse( i <= periods, crg, 0.0 )
        ccflc <- ccflc + ifelse( i <= periods, ccflg, 0.0 )
    }
    
    return( htc )
}

```

## Height Growth Prediction

We fit the equation:

$$\Delta ht = ht_{max} \beta_1 \beta_2 cr^{\beta_3} e^{(-\beta_1 ht -\beta_4 (ccfl/100) )} (1 - e^{-\beta_1 ht})^{(\beta_2-1)}$$ {#eq-hg}

to the all `r nrow(tree_subset)` growth observations, estimating $\beta_0$ through $\beta_4$.

```{r}
#| label: fit_equation
#| message: false
#| warning: false
#| include: false



if( species$n[species$SPCD == fia_species] >= min_obs )
{
    d <- tree_subset

    if( nrow( d ) > min_obs )
    {
      
        hg_fit <- minpack.lm::nlsLM( d$endHT ~ est_hg( d$endGROWYR-d$startGROWYR, 
                                      d$startHT, d$startCR, d$endCR, d$startCCFL, d$endCCFL, max_height, 
                                      b1, b2, 1.0, b4 ), d, 
                       start=c( b1= 0.002145991, b2=2.3026810, b4=1.0 ), trace=T )
          
        d$hg_hat <- predict( hg_fit )
        d$hg_res <- (d$hg_hat - d$endHT)/(d$endGROWYR-d$startGROWYR)

   }
}



```

```{r}
#| label: parameter_estimates
#| eval: false
#| message: false
#| warning: false
#| include: false


knitr::kable( p[4:8], row.names = F )

```

### Residual Analysis for @eq-hg


```{r}
#| label: residual_analysis
#| echo: false
#| message: false
#| warning: false

d |> ggplot( aes( startHT, hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 )+
    xlab("height (feet)") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( startCCFL, hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -10, 10 )+
    xlab("CCFL") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( startCR, hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -10, 10 )+
    xlab("cr (fraction of ht)") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( SICOND, hg_res ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 )+
    xlab("si (feet)") + 
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( startHT40, hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -10, 10 )+ 
    xlab( "ht40 (feet)") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( as.factor(State), hg_res) ) + 
    geom_boxplot( notch = T, varwidth = T ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 ) + 
    xlab( "State Code") + 
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( as.factor(NA_L3CODE), hg_res) ) + 
    geom_boxplot( notch = T, varwidth = T ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 ) + 
    xlab( "EcoRegion") + 
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + 
    ggtitle( "(outliers removed)") +
    scale_x_discrete(guide = guide_axis(n.dodge=3))

d |> ggplot( aes( Y, hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 )+ 
    xlab( "latitude") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( X, hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 )+ 
    xlab( "longitude") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( SLOPE/100 * cos(ASPECT*pi/180), hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 )+ 
    xlab( "slope * cos(aspect)") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")

d |> ggplot( aes( SLOPE/100 * sin(ASPECT*pi/180), hg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -10, 10 )+ 
    xlab( "slope * sin(aspect)") +
    ylab( "Height Growth Residual (ft/yr) (Pred-Act)") + ggtitle( "(outliers removed)")


# x <- d |> 
#   mutate( res=hg_res ) |> 
#   group_by( X, Y, NA_L3NAME ) |> 
#   summarize( mean_res=median( res ) )
# 
# x |> ggplot( aes( X, Y, color=Hmisc::cut2(mean_res,c(-0.04,0.05) )) ) + 
#                   geom_point() + 
#                   viridis::scale_color_viridis(discrete = T, option="magma") +
#                   labs( color="Mean HG Residual", x="", y="") +
#                   ggtitle( "L3 Height Growth Residuals" )
# 
# x |> ggplot( aes( X, Y, color=as.factor(NA_L3NAME) ) ) + 
#                   geom_point() + 
#                   #viridis::scale_color_viridis(discrete = T, option="magma") +
#                   labs( x="", y="", title="L3 Regions" ) + 
#                   theme(legend.position = "none")

x <- d |> 
  mutate( res=hg_res ) |> 
  group_by( STATECD, UNITCD, COUNTYCD ) |> 
  summarize( mean_res=mean( res), X=mean(X), Y=mean(Y) )

x %>% ggplot( aes( X, Y, color=Hmisc::cut2(mean_res,c(-0.4,0.4) )) ) + 
                  geom_point() + 
                  viridis::scale_color_viridis(discrete = T, option="magma") +
                  labs( color="Mean HG Residual", x="", y="") +
                  ggtitle( "State - Unit - County Mean Height Growth Residuals" )

d |> ggplot( aes( startHT, (hg_hat-startHT)/(endGROWYR-startGROWYR) ) ) + 
      geom_point() + 
      geom_smooth() +
      xlab( "Initial Height (feet)" ) +
      ylab( "Predicted Height Growth (feet/year)")

d |> ggplot( aes( startCCFL, (hg_hat-startHT)/(endGROWYR-startGROWYR) ) ) + 
      geom_point() + 
      geom_smooth() +
      xlab( "Initial CCFL" ) +
      ylab( "Predicted Height Growth (feet/year)")

d |> ggplot( aes( startCR, (hg_hat-startHT)/(endGROWYR-startGROWYR) ) ) + 
      geom_point() + 
      geom_smooth() +
      xlab( "Initial CR" ) +
      ylab( "Predicted Height Growth (feet/year)")
```
