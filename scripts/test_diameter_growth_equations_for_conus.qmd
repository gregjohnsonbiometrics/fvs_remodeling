---
title: "Diameter Growth Equations for CONUS"
author: "Greg Johnson, David Marshall, Aaron Weiskittel"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: prepare_data
#| message: false
#| warning: false
#| include: false

library( dplyr )
library( ggplot2 )
library(tidyverse)
library(ggdendro)


states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))

data_path <- "F:/Projects/FVS Remodel/data/"
rds_path <- "F:/Projects/FVS Remodel/fvs_remodeling/rds/"

species <- readRDS( file=paste0(rds_path,"species.RDS") )
trees <- readRDS( file=paste0(rds_path,"tree_dg_subset.RDS") )

# observation threshold
min_obs <- 5000
```

## Fit Diameter Growth Equations (no site index)

```{r}
#| label: fit_diameter_growth
#| eval: false
#| message: false
#| warning: false
#| include: false


est_dg <- function( B0, B1, B2, B3, B4, B5, dbh0, bal0, bal1, cr0, cr1, ht0, ht1, si, n )

{
    dht <- (ht1 - ht0)/n
    dbal <- (bal1 - bal0)/n
    dcr <- (cr1 - cr0)/n
    
    cht <- ht0
    cdbh <- dbh0
    cbal <- bal0
    ccr <- cr0

    max_n <- max( n )
        
    for( i in 1:max_n )
    {
          dg_hat <- exp( B0 + 
                         B1 * log( (cdbh+1)^2/(ccr*cht+1.0)^B4 ) +
                         B2 * cbal^B5/( log(cdbh+2.7) ) +
                         B3 * log( si + 1.37 ) ) 
          
          cdbh <- cdbh + ifelse( i <= n, dg_hat, 0 )
          cbal <- cbal + ifelse( i <= n, dbal, 0 )
          cht <- cht +  ifelse( i <= n, dht, 0 )
          ccr <-  ccr  + ifelse( i <= n, dcr, 0 )
    }
    
    return( cdbh )
}


# iterate through species list

fit_stats <- NULL
for( i in 25:nrow(species) )
{
    if( species$n[i] >= min_obs )
    {
        print( species$SPCD[i] )
        d <- trees %>% filter( SPCD == species$SPCD[i] )
        if( nrow(d) > min_obs )
        {
          
            nosi_fit <- try(
                nls( endDIA ~ est_dg( B0, B1, B2, 0.0, B4, B5, startDIA,
                                                              startBAL, endBAL, startCR, endCR,
                                                              startHT, endHT, SICOND,
                                                              endGROWYR-startGROWYR ),
                       data = d,
                       start= c( B0= -1.005328,   
                                 B1= -0.6217302,
                                 B2= -0.03762980,
                                 B4 = 1.637099,
                                 B5 = 0.9014009 ), trace=F ), silent=T )

            
            nosi_fit_2 <- minpack.lm::nlsLM( endDIA ~ est_dg( B0, B1, B2, 0.0, B4, B5, startDIA, startBAL, endBAL, startCR,
                                                   endCR, startHT, endHT, SICOND, endGROWYR-startGROWYR ),
                 data = d, 
                 start= c( B0= -1.005328,   
                           B1= -0.6217302,
                           B2= -0.03762980,
                           B4 = 1.637099,
                           B5 = 0.9014009 ), trace=F )
            
            opt <- 1
            if( class(nosi_fit) == "try-error" )
            {
                nosi_fit <- nosi_fit_2
                opt <- 2
            } else if( AIC(nosi_fit) > AIC(nosi_fit_2 ) ) {
                nosi_fit <- nosi_fit_2
                opt <- 2
            }
            

            x <- nosi_fit$m$getPars()
            o <- data.frame( spcd=species$SPCD[i], n=nrow(d), Common_Name=species$CommonName[i],
                             B0=x[1], B1=x[2], B2=x[3], B4=x[4], B5=x[5],
                             AIC=AIC(nosi_fit), isConv=nosi_fit$convInfo$isConv,
                             RSS=nosi_fit$m$deviance(), opt=opt )
            fit_stats <- rbind( fit_stats, o )
            print( o )
        }
    }
}

saveRDS( fit_stats, file=paste0(rds_path,"dg_parms.RDS") )


```

## Preliminary CONUS-wide Diameter Growth Equation

```{r}
#| include: false
#| 
fit_stats <- readRDS( file=paste0(rds_path,"dg_parms.RDS") )

```

We built a data set from Forest Inventory and Analysis (FIA) remeasurement data, filtering out observations with missing values for diameter at breast height (`dbh`), basal area in larger trees (`bal`), crown ratio (`cr`), total height (`ht`) and site index (`si`), and remeasurement intervals less than 5 years. We also restricted the data to species with $\ge$ `r min_obs` observations.

It should be noted that site quality is not included in this modeling effort and will need to be introduced once a uniform CONUS-wide productivity measure is derived.

The diameter growth equation fit to these data was:

$$\Delta dbh = e^{(\beta_0 + \beta_1 log(\frac{(dbh+1)^2}{(cr * ht + 1)^{\beta_4}}) + \beta_2 \frac{bal^{\beta_5}}{dbh+2.7}) }$$ {#eq-nosite}

@eq-nosite was fit to each qualifying species using an integrated fitting approach and errors minimized were ending `dbh`. `r nrow(fit_stats)` species equations were estimated. Sample sizes ranged from `r min(fit_stats$n)` to `r max(fit_stats$n)` observations.

The graphs below show the range of parameter estimates divided into Conifer and Hardwood groups. The parameter estimates are remarkable stable across species.

```{r}
#| label: examine_parameters
#| echo: false
#| message: false
#| warning: false

fit_stats2 <- fit_stats %>% mutate( type=ifelse(spcd < 300, "Conifer", "Hardwood")) 

fit_stats2 %>% ggplot( aes( type, B0 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75) ) + xlab("") +
    ggtitle( "Sets Approximate Minimum DG")
fit_stats2 %>% ggplot( aes( type, B1 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("") +
    ggtitle( "Sensitivity to Tree Size Relative to Crown")
fit_stats2 %>% ggplot( aes( type, B2 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("") +
    ggtitle( "Sensitivity to Basal Area in Larger Trees Relative to DBH")
fit_stats2 %>% ggplot( aes( type, B4 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("") +
    ggtitle( "Adjusts Crown Effects")
fit_stats2 %>% ggplot( aes( type, B5 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("")+
    ggtitle( "Adjusts Basal Area in Larger Trees Effects") 

fit_stats2 %>% mutate( MSE=RSS/n ) %>% ggplot( aes( type, MSE )) + geom_boxplot() + xlab("") + ylab("MSE (inches)")

# 1. Scale
scaled_df <- scale(fit_stats2[,c(4:8)])
row.names(scaled_df) <- fit_stats2$Common_Name

# 2. Distance Matrix
dist_matrix <- dist(scaled_df, method = "euclidean")

# 3. Hierarchical Clustering
hc <- hclust(dist_matrix, method = "ward.D2")

hc_data <- dendro_data(hc, type = "rectangle")

# Build plot manually with ggplot
ggplot(hc_data$segments, aes(x = x, y = y, xend = xend, yend = yend)) +
    geom_segment() +
    geom_text( data = hc_data$labels,
      aes(x = x, y = 0, label = label),
      inherit.aes = FALSE,
      hjust = 1,
      angle = 90,
      size = 3 ) +
      theme_dendro() + 
      #theme(plot.margin = margin(5.5, 5.5, 40, 5.5)) +
      coord_cartesian(ylim = c(-3, max(hc_data$segments$y) + 1)) +
    ggtitle( "FIA Species Clusters by Alternative Diameter Growth Parameter Estimates")
```
