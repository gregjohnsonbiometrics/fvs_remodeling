---
title: "Diameter Growth Equations for CONUS with Climate Variables"
author: "Greg Johnson, David Marshall, Aaron Weiskittel"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: prepare_data
#| message: false
#| warning: false
#| include: false


library( dplyr )
library( ggplot2 )
library(tidyverse)
library(sf)
library(terra)
library( rpart)
library( ggdendro )

reformat_nls <- function( nls_model_summary )
{
    mat_model <- nls_model_summary$coefficients
    
    dg_model <- as.data.frame(mat_model)
    colnames(dg_model) <- c("Coef.", "Std. error", "t-stat.", "p")
    
    return( dg_model )
}

states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))

data_path <- "F:/Projects/FVS Remodel/data/"
rds_path <- "F:/Projects/FVS Remodel/fvs_remodeling/rds/"
gis_path <- "F:/Projects/FVS Remodel/gis/"
unzip_path <- "F:/Projects/FVS Remodel/gis/Normal_1991_2020_bioclim"

species <- readRDS( file=paste0(rds_path,"species.RDS") )
trees <- readRDS( file=paste0(rds_path,"tree_dg_subset.RDS") ) |>
          select( VERSION, PLOT, STATECD, UNITCD, COUNTYCD, SUBP, TREE, SPCD,
                  startINVYR, startGROWYR, startDIA, startHT, startHT40, startBAL, startBAPA, startCR,
                  endINVYR, endGROWYR, endDIA, endHT, endHT40, endBAL, endBAPA, endCR,
                  SICOND, SIBASE, SISP, STDAGE,
                  LAT, LON, SLOPE, ASPECT, ELEV,
                  State )

parms <- readRDS( file=paste0(rds_path,"dg_parms.RDS") )

ecoregions <- st_read( paste0( gis_path,"ecoregions.gpkg" ) )

raster_files <- list.files(
  path = unzip_path, 
  pattern = "\\.(tif|asc)$", 
  full.names = TRUE, 
  ignore.case = TRUE
)

# 1. Load the rasters
climate_stack <- rast(raster_files)

# 2. Get the clean base names (e.g., "Normal_1991_2020_MAT")
raw_names <- gsub("\\.(tif|asc)$", "", basename(raster_files), ignore.case = TRUE)

# 3. Remove the specific prefix "Normal_1991_2020_"
# The ^ ensures it only replaces the string if it's at the beginning
clean_names <- gsub("^Normal_1991_2020_", "", raw_names)

# 4. Assign back to the stack
names(climate_stack) <- clean_names

# observation threshold
min_obs <- 5000


```

## Fit Diameter Growth Equations (no site index)

```{r}
#| label: fit_diameter_growth
#| eval: false
#| message: false
#| warning: false
#| include: false



est_dg <- function( B0, B1, B2, B3, B4, B5, B6, dbh0, bal0, bal1, cr0, cr1, ht0, ht1, ppt, emt, n )

{
    dht <- (ht1 - ht0)/n
    dbal <- (bal1 - bal0)/n
    dcr <- (cr1 - cr0)/n
    
    cht <- ht0
    cdbh <- dbh0
    cbal <- bal0
    ccr <- cr0

    max_n <- max( n )
        
    for( i in 1:max_n )
    {
      dg_hat <- exp( B0 + 
                     B1 * log( (cdbh+1)^2/(ccr*cht+1.0)^B4 ) +
                     B2 * cbal^B5/( log(cdbh+2.7) ) +
                     B3 * ppt + 
                     B6 * emt ) 
      
      cdbh <- cdbh + ifelse( i <= n, dg_hat, 0 )
      cbal <- cbal + ifelse( i <= n, dbal, 0 )
      cht <- cht +  ifelse( i <= n, dht, 0 )
      ccr <-  ccr  + ifelse( i <= n, dcr, 0 )
    }
    
    return( cdbh )
}

# iterate through species list

fit_stats <- NULL
for( i in 1:nrow(species) )
{
    if( species$n[i] >= min_obs )
    {
        #print( species$SPCD[i] )
      
        tree_subset <- trees |> filter( SPCD == species$SPCD[i] )
        
        p <- parms |> filter( spcd == species$SPCD[i] )
        
        if( nrow(p) > 0  )
        {
            x <- tree_subset |> group_by( PLOT, STATECD, UNITCD, COUNTYCD, LON, LAT ) |> summarize( n=length(LAT) )
            x <- st_as_sf( x, coords = c("LON", "LAT"), crs = 4326 )
            x <- st_transform( x, crs(climate_stack) )
            x <- cbind( x, extract( climate_stack, x ) )
            
            x <- st_transform( x, st_crs(ecoregions) )
            x <- st_join( x, ecoregions, join = st_within )
            x_cor <- st_coordinates( x )
            x <- st_drop_geometry( x )
            x <- cbind( x, x_cor )
            
            d <- x |> inner_join( tree_subset, by=c("PLOT", "STATECD","UNITCD", "COUNTYCD" )) |> 
              filter( !is.na(NA_L3NAME) & endDIA > startDIA & !is.na(PPT_sm) & !is.na(EMT) )
            
            l3_names <- unique(d$NA_L3NAME)
                  
            if( nrow(d) > min_obs )
            {
                dg_fit <- minpack.lm::nlsLM( endDIA ~ est_dg( B0, B1, B2, B3, B4, B5, B6, 
                                                startDIA, startBAL, endBAL, startCR, endCR, startHT, endHT, 
                                                PPT_sm, EMT, endGROWYR-startGROWYR ),
                               d, start = c( B0 = p$B0,
                                             B1 = p$B1, 
                                             B2 = p$B2,
                                             B3 = -0.0004800833, 
                                             B4 = p$B4,
                                             B5 = p$B5,
                                             B6 = -0.0008899783 ), trace = F )
                p2 <-dg_fit$m$getPars() 
                d$dg_hat <- est_dg( p2[1], p2[2], p2[3], p2[4], p2[5], p2[6], p2[7],
                                    d$startDIA, d$startBAL, d$endBAL, d$startCR, d$endCR, d$startHT, d$endHT,
                                    d$PPT_sm, d$EMT, d$endGROWYR-d$startGROWYR )
                d$dg_res <- (d$dg_hat - d$endDIA)/(d$endGROWYR-d$startGROWYR)
                
                o <- data.frame( spcd=species$SPCD[i], n=nrow(d), Common_Name=species$CommonName[i],
                                 B0=p2[1], B1=p2[2], B2=p2[3], B3=p2[4], B4=p2[5], B5=p2[6], B6=p2[7],
                                 AIC=AIC(dg_fit), isConv=dg_fit$convInfo$isConv,
                                 RSS=dg_fit$m$deviance() )
                fit_stats <- rbind( fit_stats, o )
                print( o )
            }
        }
    }
}

saveRDS( fit_stats, file=paste0(rds_path,"dg_parms_climate.RDS") )


```

## Preliminary CONUS-wide Diameter Growth Equation

```{r}
#| include: false
#| 
fit_stats <- readRDS( file=paste0(rds_path,"dg_parms_climate.RDS") )

```

We built a data set from Forest Inventory and Analysis (FIA) remeasurement data, filtering out observations with missing values for diameter at breast height (`dbh`), basal area in larger trees (`bal`), crown ratio (`cr`), total height (`ht`), site index (`si`), summer precipitation ($PPT_{sm}$), extreme minimum temperature (`EMT`), and remeasurement intervals less than 5 years. We also restricted the data to species with $\ge$ `r min_obs` observations.

The diameter growth equation fit to these data was:

$$\Delta dbh = e^{(\beta_0 + \beta_1 log(\frac{(dbh+1)^2}{(cr * ht + 1)^{\beta_4}}) + \beta_2 \frac{bal^{\beta_5}}{dbh+2.7} + \beta_3 PPT_{sm} + \beta_6 EMT) }$$ {#eq-dg}

where:

-   $dbh$ = diameter at breast height (inches)
-   $cr$ = crown ratio (fraction of total height)
-   $ht$ = total height (feet)
-   $bal$ = basal area in larger trees ($feet^2/acre$)
-   $PPT_{sm}$ = summer precipitation (mm)
-   $EMT$ = extreme minimum temperature ($^\circ C$)

@eq-dg was fit to each qualifying species using an integrated fitting approach and errors minimized were ending `dbh`. `r nrow(fit_stats)` species equations were estimated. Sample sizes ranged from `r min(fit_stats$n)` to `r max(fit_stats$n)` observations.

The graphs below show the range of parameter estimates divided into Conifer and Hardwood groups. The parameter estimates are remarkable stable across species.

```{r}
#| label: examine_parameters
#| echo: false
#| message: false
#| warning: false

fit_stats2 <- fit_stats %>% mutate( type=ifelse(spcd < 300, "Conifer", "Hardwood")) 

fit_stats2 %>% ggplot( aes( type, B0 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75) ) + xlab("") +
    ggtitle( "Sets Approximate Maximum DG")
fit_stats2 %>% ggplot( aes( type, B1 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("") +
    ggtitle( "Sensitivity to Tree Size Relative to Crown")
fit_stats2 %>% ggplot( aes( type, B2 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("") +
    ggtitle( "Sensitivity to Basal Area in Larger Trees Relative to DBH")
fit_stats2 %>% ggplot( aes( type, B4 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("") +
    ggtitle( "Adjusts Crown Effects")
fit_stats2 %>% ggplot( aes( type, B5 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("")+
    ggtitle( "Adjusts Basal Area in Larger Trees Effects") 
fit_stats2 %>% ggplot( aes( type, B3 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("")+
    ggtitle( "Summer Precipitation Effects") 
fit_stats2 %>% ggplot( aes( type, B6 )) + geom_violin(draw_quantiles=c(0.25,0.5,0.75)) + xlab("")+
    ggtitle( "Extreme Minimum Temperature Effects") 

fit_stats2 %>% mutate( MSE=RSS/n ) %>% ggplot( aes( type, MSE )) + geom_boxplot() + xlab("") + ylab("MSE (inches)")

# 1. Scale
scaled_df <- scale(fit_stats2[,c(4:10)])
row.names(scaled_df) <- fit_stats2$Common_Name

# 2. Distance Matrix
dist_matrix <- dist(scaled_df, method = "euclidean")

# 3. Hierarchical Clustering
hc <- hclust(dist_matrix, method = "ward.D2")

hc_data <- dendro_data(hc, type = "rectangle")

# Build plot manually with ggplot
lab_col <- rep( "gray", length( hc_data$labels$label ) )

pine <- grep( "pine",  hc_data$labels$label )
lab_col[pine] <- "red"
fir <- grep( "fir",  hc_data$labels$label )
lab_col[fir] <- "green"
oak <- grep( "oak",  hc_data$labels$label )
lab_col[oak] <- "blue"
maple <- grep( "maple",  hc_data$labels$label )
lab_col[maple] <- "purple"


ggplot(hc_data$segments, aes(x = x, y = y, xend = xend, yend = yend)) +
    geom_segment() +
    geom_text( data = hc_data$labels,
      aes(x = x, y = 0, label = label, colour = lab_col),
      inherit.aes = FALSE,
      hjust = 1,
      angle = 90,
      size = 3 ) +
      theme_dendro() + 
      coord_cartesian(ylim = c(-3, max(hc_data$segments$y) + 1)) +
    ggtitle( "FIA Species Clusters by Diameter Growth Parameter Estimates") +
    theme( legend.position = "none" )

knitr::kable( fit_stats2 |> filter( B3 < 0 ) |> inner_join( species, by=c("spcd"="SPCD" ) ) |> select( spcd, Common_Name ),
              row.names = F, col.names = c("FIA Species Code", "Common Name"),
              caption="Species with Negative Summer Precipitation Parameter" )

knitr::kable( fit_stats2 |> filter( B6 < 0 ) |> inner_join( species, by=c("spcd"="SPCD" ) ) |> select( spcd, Common_Name ),
              row.names = F, col.names = c("FIA Species Code", "Common Name"),
              caption="Species with Negative Extreme Minimum Temperature Parameter" )
```
