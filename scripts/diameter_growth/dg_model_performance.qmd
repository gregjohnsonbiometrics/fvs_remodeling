---
title: "Alternative Diameter Growth Model Performance"
author: "Greg Johnson, David Marshall, Aaron Weiskittel"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| echo: false
#| message: false
#| warning: false
#| paged-print: false

library( dplyr )
library( ggplot2 )


states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))


fit_path <- "F:/Projects/FVS Remodel/fvs_remodeling/fits/"
data_path <- "F:/Projects/FVS Remodel/data/"

species <- data.frame( fia=c( 202, 81, 122, 263, 312, 351 ), species_name=c("DF","IC","PP","WH","BM","RA"),
                       n=c(186325,9932,90751,52889,4743,9367))


fia_species <- 202
species_name <- "Douglas-fir"
states <- c( "WA", "OR", "CA", "MT", "ID", "NV", "NM", "AZ", "UT", "CO", "WY" )


# get change data
tree_data <- NULL
for( state in states )
    tree_data <- rbind( tree_data,  read.csv( paste0(data_path, state, "_CHANGEdata.CSV"), header=T, sep="," ) )

   
tree_subset <- tree_data %>% 
    filter( SPCD == fia_species &
            !is.na(startDIA) & !is.na(startBAPA) & !is.na(startBAL) & !is.na(startCR) &
            !is.na(endDIA) & !is.na(endBAPA) & !is.na(endBAL) & !is.na(endCR) &
            !is.na(startGROWYR) & !is.na(endGROWYR) & endGROWYR - startGROWYR >= 5 &
            !is.na( SICOND ) ) %>%
            mutate( startCR = startCR/100, endCR = endCR/100 ) %>%
    inner_join( state_fips, by="STATECD")

                       
# get parameters
parms <- NULL
for( i in 1:nrow(species) )
{
    x <- readRDS( paste0( fit_path, species$fia[i], "_fit.RDS") )
    p <- x$m$getPars()
    parms <- rbind( parms, data.frame( fia=species$fia[i], species_name=species$species_name[i], n=species$n[i], b0=p[1], b1=p[2], b2=p[3], b4=p[4], b5=p[5]) )
}

dg_model <- function( p, dbh, ht, cr, bal )
{
    dg_hat <- exp( p$b0 + p$b1 * log( (dbh+1)^2/(cr*ht+1.0)^p$b4 ) +
                          p$b2 * bal^p$b5/( log(dbh+2.7) ) ) 
    dg_hat
}

results <- NULL
for( i in 1:nrow(parms) )
{
    dbh <- 2
    ht <- 15.00
    cr <- 0.5000
    bal <- seq(70,146,5)
    d <- data.frame( fia=parms$fia[i], species_name=parms$species_name[i], n=parms$n[i], dbh = dbh, ht=ht, cr=cr, bal=bal )
    
    d$dg <- dg_model( parms[i,], d$dbh, d$ht, d$cr, d$bal )
    
    results <- rbind( results, d )
}

results %>% ggplot( aes( bal, dg, color=species_name ) ) + geom_point() + geom_line() + ggtitle( "dbh = 2, ht = 15, cr = 0.5" ) +
    facet_wrap( ~ifelse(n > 50000,"n > 50000","n <= 50000"))


#summary( tree_subset %>% filter( startDIA == 10 ) %>% select( startDIA, startHT, startCR, startBAL))

results <- NULL
for( i in 1:nrow(parms) )
{
    dbh <- 10
    ht <- 59.00
    cr <- 0.48
    bal <- seq(42,126,5)
    d <- data.frame( fia=parms$fia[i], species_name=parms$species_name[i], n=parms$n[i], dbh = dbh, ht=ht, cr=cr, bal=bal )
    
    d$dg <- dg_model( parms[i,], d$dbh, d$ht, d$cr, d$bal )
    
    results <- rbind( results, d )
}

results %>% ggplot( aes( bal, dg, color=species_name ) ) + geom_point() + geom_line() + ggtitle( "dbh = 10, ht = 59, cr = 0.48" ) +
    facet_wrap( ~ifelse(n > 50000,"n > 50000","n <= 50000"))


#summary( tree_subset %>% filter( startDIA == 20 ) %>% select( startDIA, startHT, startCR, startBAL))

results <- NULL
for( i in 1:nrow(parms) )
{
    dbh <- 20
    ht <- 100.00
    cr <- 0.47
    bal <- seq(17,128,5)
    d <- data.frame( fia=parms$fia[i], species_name=parms$species_name[i], n=parms$n[i], dbh = dbh, ht=ht, cr=cr, bal=bal )
    
    d$dg <- dg_model( parms[i,], d$dbh, d$ht, d$cr, d$bal )
    
    results <- rbind( results, d )
}

results %>% ggplot( aes( bal, dg, color=species_name ) ) + geom_point() + geom_line() + ggtitle( "dbh = 20, ht = 100, cr = 0.47" ) +
    facet_wrap( ~ifelse(n > 50000,"n > 50000","n <= 50000"))



results <- NULL
for( i in 1:nrow(parms) )
{
    dbh <- seq(1,30,1)
    ht <- NULL
    cr <- NULL
    bal <- NULL
    for( d in dbh )
    {
         t <- tree_subset %>% filter(startDIA == d)
         ht <- c(ht, mean(t$startHT))
         cr <- c(cr,mean(t$startCR))
         bal <- c(bal,mean(t$startBAL))
    }

    d <- data.frame( fia=parms$fia[i], species_name=parms$species_name[i], n=parms$n[i], dbh = dbh, ht=ht, cr=cr, bal=bal )
    
    d$dg <- dg_model( parms[i,], d$dbh, d$ht, d$cr, d$bal )
    
    results <- rbind( results, d )
}

results %>% ggplot( aes( dbh, dg, color=species_name ) ) + geom_point() + geom_line() + ggtitle( "mean conditions for each dbh" ) +
    facet_wrap( ~ifelse(n > 50000,"n > 50000","n <= 50000"))

```
