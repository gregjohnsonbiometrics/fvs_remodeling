---
title: "Alternative Douglas-fir Diameter Growth"
author: "Greg Johnson and David Marshall"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: setup_and_data
#| message: false
#| warning: false
#| include: false

library( dplyr )
library( ggplot2 )
library( nlme )

reformat_nls <- function( nls_model_summary )
{
    mat_model <- nls_model_summary$coefficients
    
    df_model <- as.data.frame(mat_model)
    colnames(df_model) <- c("Coef.", "Std. error", "t-stat.", "p")
    
    return( df_model )
}


data_path <- "F:/Projects/FVS Remodel/data/"


df_tree_data_or <- read.csv( paste0(data_path, "OR_CHANGEdata_DF.CSV"), header=T, sep="," )
df_tree_data_wa <- read.csv( paste0(data_path, "WA_CHANGEdata.CSV"), header=T, sep="," )
df_tree_data <- rbind( df_tree_data_or, df_tree_data_wa )
   
df_tree_subset_with_si <- df_tree_data %>% 
    filter( startSPCD == 202 &
            !is.na(startDIA) & !is.na(startBAPA) & !is.na(startBAL) & !is.na(startCR) &
            !is.na(endDIA) & !is.na(endBAPA) & !is.na(endBAL) & !is.na(endCR) &
            !is.na(startGROWYR) & !is.na(endGROWYR) & endGROWYR - startGROWYR >= 5 &
            !is.na( SICOND ) ) %>%
            mutate( startCR = startCR/100, endCR = endCR/100 )

```

## Alternative Model Formulation

An alternative to the ORGANON diameter growth equation which reduces parameter count while retaining key features of the original model is shown below. The key change is the term with a ratio of a transformation of diameter at breast height (`dbh`) squared to crown length. Since $\beta_1$ is expected to be negative, this tends to slow growth as more basal area accumulates in the tree while moderating that decline by the amount of productive crown capacity as measured by crown length. Basal area in larger trees (`bal`) serves as the inter-tree competition factor, and site index (`si`) as the inherent productivity scaling factor.

Site index is flawed for a number of reasons:

1. It is not consistently obtained for each plot due to missing Douglas-fir site trees,
2. It is estimated using a number of different and not necessarily compatible `si` equations, and
3. The available `si` equations do not all use the same base age.

In the data set `si` is derived from `r length(unique(df_tree_subset_with_si$SIEQN_REF_CD_FVS))` different site index equations for `r length(unique(df_tree_subset_with_si$SISP))` species. Douglas-fir site index comprises `r round(100*nrow(df_tree_subset_with_si %>% filter( SISP == 202 ))/nrow(df_tree_subset_with_si),0)`% of the observations. There are `r length(unique(df_tree_subset_with_si$SIBASE))` base ages used. Preliminary graphical analysis revealed that base age was most correlated with residual bias. Thus in the following, we fit two equations: one wheere `SIBASE` and `SISP` are treated as a random effects in a mixed model framework, and a second leaving site index out.

$$\Delta dbh = e^{(\beta_0 + \beta_1 log(\frac{(dbh+1)^2}{(cr * ht + 1)^{\beta_4}}) + \beta_2 \frac{bal^{\beta_5}}{dbh+2.7} + \beta_3 log( si_{s,b} + 4.5)) }$$ {#eq-withsi}
and 

$$\Delta dbh = e^{(\beta_0 + \beta_1 log(\frac{(dbh+1)^2}{(cr * ht + 1)^{\beta_4}}) + \beta_2 \frac{bal^{\beta_5}}{dbh+2.7}) }$$ {#eq-nosite}

where:

- `dbh` = diameter at breast height (inches), 
- `bal` = basal area per acre in larger trees ($feet^2/ac$), 
- `cr` = crown ratio (fraction of total height),
- `ht` = total height (feet), and 
- $si_{s,b}$ = site index (feet) for species `s` and base age `b`.
- $\beta_0 - \beta_5$ are parameters to be estimated.

Nonlinear regression was used with an integrated fitting approach such that individual observations can have differing remeasurement intervals. The error to be minimized is ending `dbh`. Since this effectively minimizes diameter growth it can weight observations with longer remeasurement intervals more heavily. The effect of this needs to be evaluated, but putting more emphasis on longer periods may be beneficial. 


The fit statistics for @eq-withsi are:

```{r}
#| label: alt_fit_with_si
#| echo: false
#| message: false
#| warning: false


est_dg_test <- function( B0, B1, B2, B3, B4, B5, dbh0, bal0, bal1, cr0, cr1, ht0, ht1, si, n )

{
    dht <- (ht1 - ht0)/n
    dbal <- (bal1 - bal0)/n
    dcr <- (cr1 - cr0)/n
    
    cht <- ht0
    cdbh <- dbh0
    cbal <- bal0
    ccr <- cr0

    max_n <- max( n )
        
    for( i in 1:max_n )
    {
          dg_hat <- exp( B0 + 
                         B1 * log( (cdbh+1)^2/(ccr*cht+1.0)^B4 ) +
                         B2 * cbal^B5/( log(cdbh+2.7) ) +
                         B3 * log( si + 4.5 ) ) 
          
          cdbh <- cdbh + ifelse( i <= n, dg_hat, 0 )
          cbal <- cbal + ifelse( i <= n, dbal, 0 )
          cht <- cht +  ifelse( i <= n, dht, 0 )
          ccr <-  ccr  + ifelse( i <= n, dcr, 0 )
    }
    
    return( cdbh )
}

#minpack.lm::nlsLM


df_fit_test <- nlme( endDIA ~ est_dg_test( B0, B1, B2, B3, B4, B5, startDIA, startBAL, endBAL, startCR,
                                                endCR, startHT, endHT, SICOND, endGROWYR-startGROWYR ),
                 data = df_tree_subset_with_si %>% 
                     mutate( SIINT=interaction(as.factor( df_tree_subset_with_si$SIBASE),as.factor(df_tree_subset_with_si$SISP == 202))), 
                 fixed = B0 + B1 + B2 + B3 + B4 + B5 ~ 1,
                 random = B3 ~ 1 | SIINT,
                 start= c(    B0= -5.67,               
                              B1= -0.57, 
                              B2= -0.096, 
                              B3=  0.81,
                              B4 = 1.72,
                              B5 = 0.63 ) ) #, trace=F )
x <- summary( df_fit_test )
#knitr::kable( reformat_nls( x ) )
print(x)
print(x$coefficients$random)
cat( paste( "Residual Standard Error:", x$sigma, "on", x$fixDF$X[1], #x$df[2], 
            "degrees of freedom, AIC:", AIC(df_fit_test) ))

```

and for @eq-nosite:


```{r}
#| label: alt_fit_no_si
#| echo: false
#| message: false
#| warning: false


df_fit_test_nosi <- minpack.lm::nlsLM( endDIA ~ est_dg_test( B0, B1, B2, 0.0, B4, B5, startDIA, startBAL, endBAL, startCR,
                                                endCR, startHT, endHT, SICOND, endGROWYR-startGROWYR ),
                 data = df_tree_subset_with_si, 
                 start= c(    B0= -5.67,               
                              B1= -0.57, 
                              B2= -0.096, 
                              B4 = 1.72,
                              B5 = 0.63 ), trace=F )
x <- summary( df_fit_test_nosi )
knitr::kable( reformat_nls( x ) )
cat( paste( "Residual Standard Error:", x$sigma, "on", x$df[2], 
            "degrees of freedom, AIC:", AIC(df_fit_test_nosi) ))

```

### Residual Analysis for @eq-withsi

```{r}
#| label: test new dg function
#| echo: false
#| message: false
#| warning: false

dg_hat <- predict( df_fit_test)
dg_res <- ( dg_hat  - df_tree_subset_with_si$endDIA ) / ( df_tree_subset_with_si$endGROWYR - df_tree_subset_with_si$startGROWYR )

df_tree_subset_with_si %>% ggplot( aes( startDIA, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +
    ylim( -0.5, 0.5 )+
    xlab("dbh (inches)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startBAPA, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("ba (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startBAL, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("bal (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startCR, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("cr (fraction of ht)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( SICOND, dg_res ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~as.factor(SIBASE) ) + #SIBASE)) + #facet_wrap( ~STATECD ) +
    ylim( -0.5, 0.5 )+
    xlab("si (feet)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative by si Base Age (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( SICOND, dg_res ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~ifelse(SISP == 202, "DF si","non DF si") ) + 
    ylim( -0.5, 0.5 )+
    xlab("si (feet)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative by si Species (outliers removed)")


df_tree_subset_with_si %>% ggplot( aes( startHT40, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+ 
    xlab( "ht40 (feet)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( as.factor(STATECD), dg_res) ) + 
    geom_boxplot( notch = T, varwidth = T ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 ) + 
    xlab( "State Code") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative (outliers removed)")


```


### Residual Analysis for @eq-nosi

```{r}
#| label: test new dg function no site
#| echo: false
#| message: false
#| warning: false

dg_hat_nosi <- predict( df_fit_test_nosi)
dg_res_nosi <- ( dg_hat_nosi  - df_tree_subset_with_si$endDIA ) / ( df_tree_subset_with_si$endGROWYR - df_tree_subset_with_si$startGROWYR )
 

df_tree_subset_with_si %>% ggplot( aes( startDIA, dg_res_nosi) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +
    ylim( -0.5, 0.5 )+
    xlab("dbh (inches)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startBAPA, dg_res_nosi) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("ba (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startBAL, dg_res_nosi) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("bal (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index  (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startCR, dg_res_nosi) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("cr (fraction of ht)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( SICOND, dg_res_nosi ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~as.factor(SIBASE) ) + 
    ylim( -0.5, 0.5 )+
    xlab("si (feet)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index by si Base Age (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( SICOND, dg_res_nosi ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~ifelse(SISP == 202, "DF si","non DF si") ) + 
    ylim( -0.5, 0.5 )+
    xlab("si (feet)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index by si Species (outliers removed)")


df_tree_subset_with_si %>% ggplot( aes( startHT40, dg_res_nosi) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+ 
    xlab( "ht40 (feet)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( as.factor(STATECD), dg_res_nosi) ) + 
    geom_boxplot( notch = T, varwidth = T ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 ) + 
    xlab( "State Code") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")


```


```{r}
#| label: with si equation performance
#| eval: false
#| message: false
#| warning: false
#| include: false

df_tree_subset_with_si %>% ggplot( aes( startDIA, (dg_hat-startDIA)/REMPER ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    xlab("dbh (inches)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative")

df_tree_subset_with_si %>% ggplot( aes( startBAPA, (dg_hat-startDIA)/REMPER ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    xlab("ba (ft^2/acre)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative")

df_tree_subset_with_si %>% ggplot( aes( startBAL, (dg_hat-startDIA)/REMPER ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    xlab("bal (ft^2/acre)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative")

df_tree_subset_with_si %>% ggplot( aes( startCR, (dg_hat-startDIA)/REMPER ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    xlab("cr (fraction of ht)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative")

df_tree_subset_with_si %>% ggplot( aes( SICOND, (dg_hat-startDIA)/REMPER ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    facet_wrap( ~as.factor(SIBASE)) +
    xlab("si (feet)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative by si Base Age")


df_tree_subset_with_si %>% ggplot( aes( SICOND, (dg_hat-startDIA)/REMPER ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    facet_wrap( ~ifelse(SISP==202,"DF si", "non DF si")) +
    xlab("si (feet)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative by si Species")

df_tree_subset_with_si %>% ggplot( aes( startHT40,  (dg_hat-startDIA)/REMPER) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    xlab( "ht40 (feet)") +
    ylab( "Predicted Diameter Growth (in/yr)") + ggtitle( "Alternative")


```

## Discussion

Removing `si` degrades the fit significantly. When `si` in its random variable form is used, the bias with the height of the largest 40 trees per acre (`ht40`) is  reduced for small values and the bias for Washington (53) is also reduced. **The question remains as to whether `si` is reliable enough to be used.**.

### Equation Behavior for Very Small Trees

```{r}
#| echo: false
#| message: false
#| warning: false
t <- df_tree_subset_with_si$startDIA == 1
d <- df_tree_subset_with_si[t,]

vtable::st( d[,c("startBAPA","startBAL","startHT","startCR","SICOND")], 
            vars=c("startBAPA","startBAL","startHT","startCR","SICOND"),
            labels=c("ba","bal","ht","cr","si"),
            title="\\label{tab:oneinchtrees}Independent Variables for One Inch dbh Trees")            

d %>% ggplot( aes( dg_hat[t]/(endGROWYR - startGROWYR)) ) + 
    geom_histogram( ) +
    xlab( "Predicted Annual Diameter Growth (inches/year)" ) +
    ggtitle( "Equation 1 Predictions for Trees with One Inch dbh Trees")
```



```{r}
#| echo: false
#| message: false
#| warning: false

d %>% ggplot( aes( dg_hat_nosi[t]/(endGROWYR - startGROWYR)) ) + 
    geom_histogram( ) +
    xlab( "Predicted Annual Diameter Growth (inches/year)" ) +
    ggtitle( "Equation 2 Predictions for Trees with One Inch dbh Trees")
```

```{r}
#| eval: false
#| include: false


est_dg_test_ht40 <- function( B0, B1, B2, B3, B4, B5, dbh0, bal0, bal1, cr0, cr1, ht0, ht1, ht400, ht401, n )

{
    dht <- (ht1 - ht0)/n
    dbal <- (bal1 - bal0)/n
    dcr <- (cr1 - cr0)/n
    dht40 <- (ht401 - ht400)/n
    
    cht <- ht0
    cdbh <- dbh0
    cbal <- bal0
    ccr <- cr0
    cht40 <- ht400

    max_n <- max( n )
        
    for( i in 1:max_n )
    {
          dg_hat <- exp( B0 + 
                         B1 * log( (cdbh+1)^2/(ccr*cht+1.0)^B4 ) +
                         B2 * cbal^B5/( log(cdbh+2.7) ) +
                         B3 * (1/(cht40+1)) ) 
          
          cdbh <- cdbh + ifelse( i <= n, dg_hat, 0 )
          cbal <- cbal + ifelse( i <= n, dbal, 0 )
          cht <- cht   +  ifelse( i <= n, dht, 0 )
          ccr <-  ccr  + ifelse( i <= n, dcr, 0 )
          cht40 <- cht40 + ifelse( i <= n, dht40, 0 )
    }
    
    return( cdbh )
}



df_fit_test_ht40 <- minpack.lm::nlsLM( endDIA ~ est_dg_test_ht40( B0, B1, B2, B3, B4, B5, startDIA, startBAL, endBAL, startCR,
                                                endCR, startHT, endHT, startHT40, endHT40, endGROWYR-startGROWYR ),
                 data = df_tree_subset_with_si, 
                 start= c(    B0= -5.67,               
                              B1= -0.57, 
                              B2= -0.096,
                              B3 = 0.1,
                              B4 = 1.72,
                              B5 = 0.63 ), trace=T )
x <- summary( df_fit_test_ht40 )
knitr::kable( reformat_nls( x ) )
cat( paste( "Residual Standard Error:", x$sigma, "on", x$df[2], 
            "degrees of freedom, AIC:", AIC(df_fit_test_ht40) ))



dg_hat_ht40 <- predict( df_fit_test_ht40)
dg_res_ht40 <- ( dg_hat_ht40  - df_tree_subset_with_si$endDIA ) / ( df_tree_subset_with_si$endGROWYR - df_tree_subset_with_si$startGROWYR )
 

df_tree_subset_with_si %>% ggplot( aes( startDIA, dg_res_ht40) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +
    ylim( -0.5, 0.5 )+
    xlab("dbh (inches)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startBAPA, dg_res_ht40) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("ba (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startBAL, dg_res_ht40) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("bal (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index  (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( startCR, dg_res_ht40) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+
    xlab("cr (fraction of ht)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( SICOND, dg_res_ht40 ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~as.factor(SIBASE) ) + 
    ylim( -0.5, 0.5 )+
    xlab("si (feet)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index by si Base Age (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( SICOND, dg_res_ht40 ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~ifelse(SISP == 202, "DF si","non DF si") ) + 
    ylim( -0.5, 0.5 )+
    xlab("si (feet)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index by si Species (outliers removed)")


df_tree_subset_with_si %>% ggplot( aes( startHT40, dg_res_ht40) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    facet_wrap( ~STATECD ) +    
    ylim( -0.5, 0.5 )+ 
    xlab( "ht40 (feet)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

df_tree_subset_with_si %>% ggplot( aes( as.factor(STATECD), dg_res_ht40) ) + 
    geom_boxplot( notch = T, varwidth = T ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 ) + 
    xlab( "State Code") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Alternative No Site Index (outliers removed)")

```

