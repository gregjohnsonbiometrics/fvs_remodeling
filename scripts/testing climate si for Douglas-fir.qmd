---
title: "Testing Climate SI for Douglas-fir Diameter Growth"
author: "Greg Johnson, Aaron Weiskittel, and David Marshall"
date: today
format: pdf
editor: visual
fig-format: png
---

## Model

$$\Delta dbh = e^{(\beta_0 + \beta_1 log(\frac{(dbh+1)^2}{(cr * ht + 1)^{\beta_4}}) + \beta_2 \frac{bal^{\beta_5}}{dbh+2.7} + \beta_3 log( csi + 1.37)) }$$ {#eq-withsi}

where:

-   `dbh` = diameter at breast height (inches),
-   `bal` = basal area per acre in larger trees ($feet^2/ac$),
-   `cr` = crown ratio (fraction of total height),
-   `ht` = total height (feet),
-   `csi` = climate site index (meters), and
-   $\beta_0 - \beta_5$ are parameters to be estimated.

Climate site index (`csi`) was developed by Aaron Weiskittel and represents a CONUS-wide consistent estimate of productivity.

Nonlinear regression was used with an integrated fitting approach such that individual observations can have differing remeasurement intervals. The error to be minimized is ending `dbh`.

```{r}
#| label: setup_and_data
#| message: false
#| warning: false
#| include: false

library( terra )

library( dplyr )
library( ggplot2 )
library(tidyverse)
library(ggdendro)


states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))

data_path <- "F:/Projects/FVS Remodel/data/"
rds_path <- "F:/Projects/FVS Remodel/fvs_remodeling/rds/"
fits_path <- "F:/Projects/FVS Remodel/fvs_remodeling/fits/"
gis_path <- "F:/Projects/FVS Remodel/gis/"

fia_species <- 202
species_name <- "Douglas-fir"

reformat_nls <- function( nls_model_summary )
{
    mat_model <- nls_model_summary$coefficients
    
    dg_model <- as.data.frame(mat_model)
    colnames(dg_model) <- c("Coef.", "Std. error", "t-stat.", "p")
    
    return( dg_model )
}

species <- readRDS( file=paste0(rds_path,"species.RDS") )
trees <- readRDS( file=paste0(rds_path,"tree_dg_subset.RDS") )

trees_df <- trees %>% filter( SPCD == fia_species )

# observation threshold
min_obs <- 5000

#####

climate_si <- rast(paste0(gis_path, "ClimateNA_ECO_SI_m .tif"))
climate_si <- project( climate_si, "EPSG:4326" )

coords <- cbind(trees_df$LON, trees_df$LAT)

# Create SpatVector from coordinates and assign the same CRS
pts <- vect(coords, crs = "+proj=longlat +datum=WGS84")
pts <- project( pts, "EPSG:4326" )

si <- terra::extract(climate_si, pts)$lyr1

trees_df$csi <- si
tree_subset <- trees_df %>% filter( !is.na(csi) )

```

## Data

We extracted and processed Forest Inventory and Analysis (FIA) data from `r length(unique(tree_subset$STATECD))` states listed in the native range of `r species_name` in the Silvics of North America.[^1]

[^1]: Burns, Russell M., and Barbara H. Honkala, tech. coords. 1990. Silvics of North America: 1. Conifers; 2. Hardwoods. Agriculture Handbook 654. U.S. Department of Agriculture, Forest Service, Washington, DC. vol.2, 877 p.

After subsetting the data to censor observations with missing data, limiting the species to `r species_name` (FIA species code `r fia_species`), and remeasurement intervals $\ge$ 5 years we get the observations in Table \ref{tbl:statesum}.

```{r}
#| label: state_breakdown
#| echo: false
#| message: false
#| warning: false

x <- tree_subset %>% group_by( State ) %>% summarise( n = length(startDIA))

knitr::kable( x[,c("State","n")], row.names = F, col.names = c("State", "Observations"),
              caption = paste("\\label{tbl:statesum}", species_name, "Growth Observations by State" ) )
```

```{r}
#| label: model
#| message: false
#| warning: false
#| include: false


est_dg <- function( B0, B1, B2, B3, B4, B5, dbh0, bal0, bal1, cr0, cr1, ht0, ht1, si, n )
    
{
    dht <- (ht1 - ht0)/n
    dbal <- (bal1 - bal0)/n
    dcr <- (cr1 - cr0)/n
    
    cht <- ht0
    cdbh <- dbh0
    cbal <- bal0
    ccr <- cr0
    
    max_n <- max( n )
    
    for( i in 1:max_n )
    {
        dg_hat <- exp( B0 + 
                       B1 * log( (cdbh+1)^2/(ccr*cht+1.0)^B4 ) +
                       B2 * cbal^B5/( log(cdbh+2.7) ) +
                       B3 * log( si + 1.37 ) ) 
        
        cdbh <- cdbh + ifelse( i <= n, dg_hat, 0 )
        cbal <- cbal + ifelse( i <= n, dbal, 0 )
        cht <-  cht  + ifelse( i <= n, dht, 0 )
        ccr <-  ccr  + ifelse( i <= n, dcr, 0 )
    }
    
    return( cdbh )
}

```

## Equation Parameter Estimates

```{r}
#| label: fit_model
#| echo: false
#| message: false
#| warning: false

si_fit <- minpack.lm::nlsLM( endDIA ~ est_dg( B0, B1, B2, B3, B4, B5, 
                                startDIA, 
                                startBAL, endBAL, 
                                startCR, endCR, 
                                startHT, endHT, 
                                csi, 
                                endGROWYR-startGROWYR ),
                data = trees_df, 
                start= c(    B0= -5.3085995,               
                             B1= -0.70, 
                             B2= -0.09, 
                             B3=  0.58,
                             B4 = 2.19,
                             B5 = 0.56 ), trace=F )
x <- summary( si_fit )
knitr::kable( reformat_nls( x ) )
cat( paste( "Residual Standard Error:", x$sigma, "on", x$df[2], 
            "degrees of freedom, AIC:", round(AIC(si_fit),1) ))

```

## Comparison to Simplified Model without Climate SI

```{r}
#| label: old_model
#| echo: false
#| message: false
#| warning: false

old_fit <- readRDS( paste0(fits_path, fia_species, "_fit.RDS") )

x <- summary( old_fit )
knitr::kable( reformat_nls( x ) )
cat( paste( "Residual Standard Error:", x$sigma, "on", x$df[2], 
            "degrees of freedom, AIC:", round(AIC(old_fit),1) ))

```

While `csi` improves the fit significantly, it does not remove the geographic residuals patterns in the residuals (see the last graph below).

### Residual Analysis for @eq-withsi

```{r}
#| label: dg function with site
#| echo: false
#| message: false
#| warning: false

dg_hat <- predict( si_fit )
dg_res <- ( dg_hat - tree_subset$endDIA ) / ( tree_subset$endGROWYR - tree_subset$startGROWYR )

tree_subset %>% ggplot( aes( startDIA, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +
    ylim( -0.5, 0.5 )+
    xlab("dbh (inches)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( startBAPA, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -0.5, 0.5 )+
    xlab("ba (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( startBAL, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -0.5, 0.5 )+
    xlab("bal (ft^2/acre)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( startCR, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -0.5, 0.5 )+
    xlab("cr (fraction of ht)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( csi, dg_res ) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 )+
    xlab("climate si (meters)") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")


tree_subset %>% ggplot( aes( startHT40, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    # facet_wrap( ~State ) +    
    ylim( -0.5, 0.5 )+ 
    xlab( "ht40 (feet)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( as.factor(State), dg_res) ) + 
    geom_boxplot( notch = T, varwidth = T ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 ) + 
    xlab( "State Code") + 
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")


tree_subset %>% ggplot( aes( LAT, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 )+ 
    xlab( "latitude") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( LON, dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 )+ 
    xlab( "longitude") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")

tree_subset %>% ggplot( aes( SLOPE/100 * cos(ASPECT*pi/180), dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 )+ 
    xlab( "slope * cos(aspect)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")


tree_subset %>% ggplot( aes( SLOPE/100 * sin(ASPECT*pi/180), dg_res) ) + 
    geom_point() + 
    geom_smooth( method = 'gam',   formula = y ~ s(x, bs = "cs") ) + 
    geom_abline( intercept = 0, slope = 0 ) +
    ylim( -0.5, 0.5 )+ 
    xlab( "slope * sin(aspect)") +
    ylab( "Diameter Growth Residual (in/yr) (Pred-Act)") + ggtitle( "Diameter Growth Model with Climate SI", 
                                                                    subtitle = "Outliers Removed")


x <- tree_subset %>% mutate( res=dg_res ) %>% group_by( LON, LAT ) %>% summarize( mean_res=mean( res ) )

x %>% ggplot( aes( LON, LAT, color=Hmisc::cut2(mean_res,c(-0.04,0.05) )) ) + 
                  geom_point() + 
                  viridis::scale_color_viridis(discrete = T, option="magma") +
                  labs( color="Mean DG Residual") +
                  ggtitle( "Diameter Growth Model with Climate SI" )
```
