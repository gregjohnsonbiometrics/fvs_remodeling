---
title: "Alternative Douglas-fir Height Growth"
author: "Greg Johnson and David Marshall"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: setup_and_data
#| message: false
#| warning: false
#| include: false

library( dplyr )
library( ggplot2 )
library( nlme )

states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))



reformat_nls <- function( nls_model_summary )
{
    mat_model <- nls_model_summary$coefficients
    
    df_model <- as.data.frame(mat_model)
    colnames(df_model) <- c("Coef.", "Std. error", "t-stat.", "p")
    
    return( df_model )
}


data_path <- "F:/Projects/FVS Remodel/data/"

df_states <- c( "WA", "OR", "CA", "MT", "ID", "NV", "NM", "AZ", "UT", "CO", "WY")

# get change data
df_tree_data <- NULL
for( state in df_states )
    df_tree_data <- rbind( df_tree_data,  read.csv( paste0(data_path, state, "_CHANGEdata.CSV"), header=T, sep="," ) )

   
df_subset <- df_tree_data %>% 
    filter( startSPCD == 202 &
            !is.na(startHT) & !is.na(startCCH) & !is.na(startCCFL) & !is.na(startCR) &
            !is.na(endHT) & !is.na(endCCH) & !is.na(endCCFL) & !is.na(endCR) & # startCCH < 100 &
            !is.na(startGROWYR) & !is.na(endGROWYR) & endGROWYR - startGROWYR >= 5 &
            !is.na( SICOND ) ) %>%
            mutate( startCR = startCR/100, endCR = endCR/100 ) %>%
            inner_join( state_fips, by=c("STATECD") )


```

## Data

We extracted and processed Forest Inventory and Analysis (FIA) data from `r length(unique(df_subset$STATECD))` states listed in the native range of Douglas-fir in the Silvics of North America.[^1]

[^1]: Burns, Russell M., and Barbara H. Honkala, tech. coords. 1990. Silvics of North America: 1. Conifers; 2. Hardwoods. Agriculture Handbook 654. U.S. Department of Agriculture, Forest Service, Washington, DC. vol.2, 877 p.

After subsetting the data to censor observations with missing data, limiting the species to Douglas-fir (FIA species code 202), and remeasurement intervals $\ge$ 5 years we get the observations in Table \ref{tbl:statesum}.

```{r}
#| label: state_breakdown
#| echo: false
#| message: false
#| warning: false

x <- df_subset %>% group_by( State ) %>% summarise( n = length(startDIA))

knitr::kable( x, row.names = F, col.names = c("State", "Observations"),
              caption = "\\label{tbl:statesum} Douglas-fir Growth Observations by State")
```

Average height growth over the remeasurement period is graphed over candidate explanatory variables below.

```{r}
#| label: graph_hg
#| echo: false
#| message: false
#| warning: false

df_subset %>% ggplot( aes( startHT, (endHT-startHT)/(endGROWYR-startGROWYR) )) + geom_point() + geom_smooth() + 
    xlab( "Height (feet)" ) + ylab( "Height Growth (feet/year)")
df_subset %>% ggplot( aes( startCCFL, (endHT-startHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "CCFL" ) + ylab( "Height Growth (feet/year)")
df_subset %>% ggplot( aes( startCCH, (endHT-startHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "CCH" ) + ylab( "Height Growth (feet/year)") + xlim(c(0,1000)) + ggtitle( "CCH > 1000 Removed")
df_subset %>% ggplot( aes( SICOND, (endHT-startHT)/(endGROWYR-startGROWYR) ), ) + geom_point() + geom_smooth() + facet_wrap( ~SIEQN_REF_CD_FVS ) + 
    xlab( "Site Index (feet)" ) + ylab( "Height Growth (feet/year)") + ggtitle( "by SI Equation")
df_subset %>% ggplot( aes( STDAGE, (endHT-startHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "Stand Age (years)" ) + ylab( "Height Growth (feet/year)") 


df_subset %>% filter( STDAGE %% 5 == 0 & STDAGE <= 100 ) %>% ggplot( aes( as.factor(STDAGE), startHT ) ) + 
    geom_boxplot(varwidth = T, notch = T, outliers = F) + 
    xlab( "Stand Age (years)" ) + ylab( "Height (feet)") + ggtitle( "Ages <= 100 on 5-Year Points, Outliers Removed")
```
