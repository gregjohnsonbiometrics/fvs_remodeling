---
title: "Douglas-fir Height Growth from FIA Data"
author: "Greg Johnson, David Marshall, and Aaron Weiskittel"
date: today
format: pdf
editor: visual
fig-format: png
---

```{r}
#| label: setup_and_data
#| message: false
#| warning: false
#| include: false

library( dplyr )
library( ggplot2 )
library( nlme )


states <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
fips_codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

state_fips <- data.frame(State = states, STATECD = as.numeric(fips_codes))

reformat_nls <- function( nls_model_summary )
{
    mat_model <- nls_model_summary$coefficients
    
    dg_model <- as.data.frame(mat_model)
    colnames(dg_model) <- c("Coef.", "Std. error", "t-stat.", "p")
    
    return( dg_model )
}


data_path <- "F:/Projects/FVS Remodel/data/"

states <- c( "WA", "OR", "CA", "MT", "ID", "NV", "NM", "AZ", "UT", "CO", "WY" )

fia_species <- 202
species_name <- "Douglas-fir"

# get change data
tree_data <- NULL
for( state in states )
    tree_data <- rbind( tree_data,  read.csv( paste0(data_path, state, "_CHANGEdata.CSV"), header=T, sep="," ) )

   
tree_subset <- tree_data %>% 
    filter( SPCD == fia_species &
            !is.na(startACTUALHT) & !is.na(endACTUALHT) & !is.na(startCCH) & !is.na(startCCFL) & !is.na(startCR) &
            !is.na(endCCH) & !is.na(endCCFL) & !is.na(endCR) & 
            !is.na(startGROWYR) & !is.na(endGROWYR) & endGROWYR - startGROWYR >= 5 &
            !is.na( SICOND ) ) %>%
            mutate( startCR = startCR/100, endCR = endCR/100 ) %>%
            inner_join( state_fips, by=c("STATECD") )


```

## Data

We extracted and processed Forest Inventory and Analysis (FIA) data from `r length(unique(tree_subset$STATECD))` states listed in the native range of `r species_name` in the Silvics of North America.[^1]

[^1]: Burns, Russell M., and Barbara H. Honkala, tech. coords. 1990. Silvics of North America: 1. Conifers; 2. Hardwoods. Agriculture Handbook 654. U.S. Department of Agriculture, Forest Service, Washington, DC. vol.2, 877 p.

After subsetting the data to censor observations with missing data, limiting the species to `r species_name` (FIA species code `r fia_species`), and remeasurement intervals $\ge$ 5 years we get the observations in Table \ref{tbl:statesum}.

```{r}
#| label: state_breakdown
#| echo: false
#| message: false
#| warning: false

x <- tree_subset %>% group_by( State ) %>% summarise( n = length(startDIA))

knitr::kable( x, row.names = F, col.names = c("State", "Observations"),
              caption = paste("\\label{tbl:statesum}", species_name, "Height Growth Observations by State") )
```

Average height growth over the remeasurement period is graphed over candidate explanatory variables below.

```{r}
#| label: graph_hg
#| echo: false
#| message: false
#| warning: false

tree_subset %>% ggplot( aes( startACTUALHT, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) )) + geom_point() + geom_smooth() + 
    xlab( "Height (feet)" ) + ylab( "Height Growth (feet/year)") + ylim(-7,7) + ggtitle( "Outliers Removed") 
tree_subset %>% ggplot( aes( startCCFL, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "CCFL" ) + ylab( "Height Growth (feet/year)")  + ylim(-7,7) + ggtitle( "Outliers Removed") 
tree_subset %>% ggplot( aes( startCCH, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "CCH" ) + ylab( "Height Growth (feet/year)") + xlim(c(0,2)) + ylim(-7,7) + ggtitle( "Outliers Removed") 
tree_subset %>% ggplot( aes( SICOND, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ), ) + geom_point() + geom_smooth() + facet_wrap( ~SIEQN_REF_CD_FVS ) + 
    xlab( "Site Index (feet)" ) + ylab( "Height Growth (feet/year)") + ggtitle( "by SI Equation") + ylim(-7,7)
tree_subset %>% ggplot( aes( STDAGE, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "Stand Age (years)" ) + ylab( "Height Growth (feet/year)")  + ylim(-7,7) + ggtitle( "Outliers Removed") 


tree_subset %>% filter( STDAGE %% 5 == 0 & STDAGE <= 100 ) %>% ggplot( aes( as.factor(STDAGE), startACTUALHT ) ) + 
    geom_boxplot(varwidth = T, notch = T, outliers = F) + 
    xlab( "Stand Age (years)" ) + ylab( "Height (feet)") + ggtitle( "Ages <= 100 on 5-Year Points, Outliers Removed")

tree_subset %>% ggplot( aes( startACTUALHT, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) )) + geom_point() + geom_smooth() + 
    xlab( "Height (feet)" ) + ylab( "Height Growth (feet/year)") + ylim(0,7) + ggtitle( "Outliers and Negative Growth Removed") 
tree_subset %>% ggplot( aes( startCCFL, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "CCFL" ) + ylab( "Height Growth (feet/year)")  + ylim(0,7) + ggtitle( "Outliers Removed") 
tree_subset %>% ggplot( aes( startCCH, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "CCH" ) + ylab( "Height Growth (feet/year)") + xlim(c(0,2)) +  ylim(0,7) + ggtitle( "Outliers and Negative Growth Removed") 
tree_subset %>% ggplot( aes( STDAGE, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) ) ) + geom_point() + geom_smooth() + 
    xlab( "Stand Age (years)" ) + ylab( "Height Growth (feet/year)")  + ylim(0,7) + ggtitle( "Outliers and Negative Growth Removed") 

tree_subset %>% ggplot( aes( (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR) )) + geom_histogram( binwidth = 0.1 ) +
    xlab( "Height Growth (feet/year)") + xlim( c(-5,5) )

tree_subset %>% ggplot( aes( STDAGE, startHT40, color=Hmisc::cut2(SICOND,g=5) ) ) + geom_point( size=0.25 ) +
    geom_smooth() + 
    xlab( "Stand Age (years)" ) + ylab( "Height 40 (feet)") + labs( color="Site Index (feet)" ) + xlim(c(0,70))

tree_subset %>% ggplot( aes( STDAGE, startHT40, color=Hmisc::cut2(SICOND,g=5) ) ) +
    geom_smooth() + 
    xlab( "Stand Age (years)" ) + ylab( "Height 40 (feet)") + labs( color="Site Index (feet)" )
    
tree_subset %>% ggplot( aes( startACTUALHT, endACTUALHT )) + geom_point() + geom_smooth() +
    geom_abline( intercept = 0, slope=1, col="white" ) +
    xlab( "Initial Height (feet)" ) + ylab( "Final Height (feet)" ) + 
    facet_wrap( ~(endGROWYR-startGROWYR) ) + ggtitle( "by Remeasurement Interval (years)")

```

```{r}

tree_subset %>% mutate( ht_mai = startACTUALHT/STDAGE ) %>% ggplot( aes( startACTUALHT, ht_mai ) ) + geom_smooth() + xlim( c(0,100)) 

tree_subset %>% mutate( ht_mai = startACTUALHT/STDAGE ) %>% ggplot( aes( startHT40, ht_mai ) ) + geom_smooth()  + xlim( c(0,100)) 

```

```{r}
#| echo: false
#| message: false
#| warning: false

x <- as.data.frame( tree_subset %>% 
                        group_by( PLOT, STATECD, UNITCD, COUNTYCD, LAT, LON ) %>% 
                        summarize( ht40=mean(startHT40), age=mean(STDAGE,na.rm=T) ) %>%
                        filter( !is.na(age) ) ) 

ht40_fit <- minpack.lm::nlsLM( ht40 ~ b0 + b1*(1-exp(-b2*age))^b3, data=x, 
                 start=c(b0=1.5, b1=125, b2=0.001, b3=0.47), trace=T )

ht40_hat <- predict( ht40_fit )

x$ht40_hat <- ht40_hat
x$ratio <- x$ht40 / x$ht40_hat

x2 <- tree_subset %>% inner_join( x %>% select( -age, -ht40, -ht40_hat ), by=c("PLOT","STATECD","UNITCD","COUNTYCD","LAT","LON"))

x2 %>% ggplot( aes( startACTUALHT, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR), color=Hmisc::cut2(ratio,c(0.5,1,1.5)) )) + 
    geom_point() + 
    geom_smooth() + 
    xlab( "Height (feet)" ) + 
    ylab( "Height Growth (feet/year)") + 
    ylim(-7,7) + labs(color="HT40 Ratio") +
    ggtitle( "Douglas-fir, Outliers Removed") 

x2 %>% ggplot( aes( startACTUALHT, (endACTUALHT-startACTUALHT)/(endGROWYR-startGROWYR), color=Hmisc::cut2(ratio,c(0.5,1,1.5)) ) ) + 
    geom_smooth() + 
    xlab( "Height (feet)" ) + 
    ylab( "Height Growth (feet/year)") + 
    ggtitle( "Douglas-fir, Outliers Removed") + xlim( c(0,NA)) + labs(color="HT40 Ratio") 

knitr::kable( x2 %>% group_by( HT40_ratio= Hmisc::cut2(ratio,c(0.5,1,1.5)) ) %>% summarize( n=length(startHT40)), format = "html"   )


x3 <- x %>% group_by( LON, LAT ) %>% summarize( mean_ratio=mean( ratio ) )

x3 %>% ggplot( aes( LON, LAT, color=Hmisc::cut2(mean_ratio,g=5 )) ) + 
                  geom_point( size=0.75) + 
                  viridis::scale_color_viridis(discrete = T, option="magma") +
                  labs( color="Mean HT40 Ratio") +
    labs(color="HT40_ratio") +  ggtitle( "Douglas-fir")

```

